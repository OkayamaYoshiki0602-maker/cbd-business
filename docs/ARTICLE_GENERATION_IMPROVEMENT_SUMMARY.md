# 記事生成機能の改善サマリー

> **作成日:** 2026-01-17  
> **目的:** 過去記事の構造を正確に反映し、2026年対応、SWELLブロック構造の正確な変換を実現

---

## 📋 改善内容

### 1. 年号の修正（2026年対応）

**問題:**
- 生成された記事に「2024年最新版」などが含まれていた
- 現在は2026年である

**修正:**
- `article_generator_v2.py`のプロンプトに現在の年（2026年）を明示的に指定
- `datetime.now().year`を使用して動的に年号を取得

**変更箇所:**
```python
current_year = datetime.now().year
prompt = f"""...
**重要: 現在は{current_year}年です。日付や年号を記載する際は必ず{current_year}年を使用してください。**
...
```

---

### 2. 過去記事構造の正確な反映

**問題:**
- 過去記事（`naturecan-review-complete.html`など）の構造が正確に反映されていなかった
- 「この記事で分かること」ボックスの配置が正しくない
- 見出し階層が正しくない（H2が複数、H3が正しく配置されていない）

**修正:**
- プロンプトに過去記事の構造を詳細に記載
- **正確な構造:**
  1. H2見出し（タイトル、1つのみ）
  2. 導入（段落、見出しではない）
  3. 「この記事で分かること」ボックス（段落+リスト、見出しではない）
  4. H3見出し（メインセクション、3-5セクション）
  5. H4見出し（サブセクション、必要に応じて）

**変更箇所:**
- `article_generator_v2.py`: プロンプトを詳細化
- 出力形式テンプレートを過去記事の構造に合わせて修正

---

### 3. HTML変換ロジックの改善

**問題:**
- 見出しが段落として処理されている（`<p>### セクション1</p>`）
- デメリットリストが`is-style-good_list`になっている
- 「この記事で分かること」ボックスの検出が正しく動作していない

**修正:**
- 変換順序を明確化：見出し → 太字 → リンク → リスト → 段落
- `detect_toc_section`関数を追加（「この記事で分かること」セクションを検出）
- `detect_list_style`関数を改善（前の行からコンテキストを正確に取得）
- 段落変換を行単位で処理（既にHTMLタグが含まれている行をスキップ）

**変更箇所:**
- `markdown_to_swell_html.py`:
  - `detect_toc_section`: TOCセクション検出機能を追加
  - `detect_list_style`: スタイル判定を改善（prev_lineを正確に取得）
  - `convert_lists_to_swell`: TOCボックスを自動生成
  - `markdown_to_swell_html`: 変換順序を明確化、段落変換を改善

---

### 4. プロンプトの改善

**改善点:**
- 「この記事で分かること」の記述方法を明確化（見出しではなく、通常のテキストとして）
- 見出し階層の指定を明確化（H2→H3→H4の順）
- リストスタイルの使い分けを説明
- 出力形式テンプレートを詳細化

**変更箇所:**
- `article_generator_v2.py`: プロンプトを大幅に改善

---

## ⚠️ 残っている課題

### 1. H2見出しの重複

**問題:**
- 「導入」がH2見出しとして生成されている
- 本来は段落として記述すべき

**対策:**
- プロンプトで「導入」は見出しではなく段落として記述するように明確化（修正済み）
- 生成されたMarkdownを確認して、正しく記述されているか検証

### 2. デメリットリストのスタイル判定

**問題:**
- デメリットリストが`is-style-good_list`になっている
- `detect_list_style`が正しく動作していない可能性

**対策:**
- `detect_list_style`関数を改善（修正済み）
- 前の行を正確に取得するロジックを追加（修正済み）
- テストを実行して確認

### 3. 生成されたコンテンツの確認

**次のステップ:**
- 実際に記事を生成して、WordPressで確認
- 生成されたHTMLの構造を検証
- 必要に応じてプロンプトや変換ロジックを微調整

---

## 📝 テスト結果

### 変換テスト

```markdown
# 【決定版】テスト記事タイトル
## 導入
CBD選びで、絶対に失敗したくない。

この記事で分かること:
- 項目1
- 項目2

### セクション1
メリット:
- メリット1

デメリット:
- デメリット1
```

**変換結果:**
- ✅ アフィリエイト免責事項が冒頭に追加
- ✅ H2見出しに`is-style-default`が適用
- ✅ 「この記事で分かること」ボックスが正しく生成
- ✅ H3見出しが正しく変換
- ⚠️ 「導入」がH2見出しとして変換されている（修正必要）
- ⚠️ デメリットリストが`is-style-good_list`になっている（修正必要）

---

## 🚀 次のステップ

1. **実際の記事生成テスト**
   - 新しい記事を生成
   - WordPressで確認
   - 生成されたHTMLの構造を検証

2. **プロンプトの微調整**
   - 「導入」を段落として記述するように強化
   - リストスタイルの判定を改善

3. **変換ロジックの最終調整**
   - H2見出しの重複を防ぐ
   - デメリットリストのスタイル判定を修正

---

**作成日:** 2026-01-17  
**最終更新:** 2026-01-17
