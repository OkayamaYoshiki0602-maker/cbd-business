# 関連記事の自動連携機能 - 実装レポート

**実装日**: 2026年1月17日  
**優先度**: 4（ユーザー優先度リスト）  
**ステータス**: ✅ 完了

---

## 📋 概要

CBD サイトの**サイト滞在時間向上**と**記事間の連携強化**を目的として、新規記事生成時に自動的に関連記事を推奨し、HTML に追加する機能を実装しました。

---

## 🎯 実装目標

1. **自動キーワード抽出**: 記事タイトルとキーワードから主要トピックを自動抽出
2. **AI による関連記事推奨**: Gemini API を活用して最適な関連記事を提案
3. **HTML への自動統合**: 記事の最後に「関連記事」セクションを追加
4. **ユーザー体験向上**: 読者が次の記事への興味を持ちやすくする設計

---

## 🔧 実装内容

### 1. 関連記事推奨エンジン (`related_articles_connector.py`)

```python
# 主要な関数

- extract_keywords_from_title(title: str) → List[str]
  記事タイトルから主要キーワード（最大5個）を抽出

- find_related_articles(...) → List[Tuple[str, str, float]]
  キーワードマッチングで関連記事を検索（従来方式）

- find_related_articles_by_ai(...) → List[Tuple[str, str, str]]
  AI を使用して関連記事を推奨（本実装）

- generate_related_articles_section(...) → str
  関連記事セクションのHTML を生成
```

#### AI による関連記事推奨ロジック

```
新規記事のタイトルとキーワード
    ↓
Gemini API へ既存記事一覧と共に送信
    ↓
AI が最適な関連記事を3件選定
    ↓
スコア付き推奨リストを返却
```

### 2. HTML 自動生成

生成される「関連記事」セクション:

```html
<hr class="wp-block-separator has-css-opacity is-style-wide"/>

<h3 class="wp-block-heading">関連記事</h3>

<p>このテーマについて、さらに詳しく知りたい方は以下の記事も参考にしてください。</p>

<ul>
  <li><a href="[URL]" target="_blank" rel="noopener noreferrer">[記事タイトル]</a></li>
  <li><a href="[URL]" target="_blank" rel="noopener noreferrer">[記事タイトル]</a></li>
  <li><a href="[URL]" target="_blank" rel="noopener noreferrer">[記事タイトル]</a></li>
</ul>
```

### 3. article_generator_html_v2.py への統合

記事生成フロー:

```
ステップ1: タイトル候補を生成
ステップ2: メタデータを生成
ステップ3: SEO スラッグを生成
ステップ4: HTML 記事を生成
ステップ4.5: ✨【新】関連記事を自動推奨 ✨
ステップ5: WordPress に投稿
ステップ6: Article_Theme シートを更新
ステップ7: LINE 通知を送信
```

---

## 📊 実装結果

### テスト実行

```
✅ 2件の記事を生成

記事1: 【2026年版】CBD初心者向け！失敗しないための3つのステップと安全な選び方
  投稿ID: 1184
  推奨関連記事: 3件

記事2: 夜中に目覚める悩み、もう終わりに！CBDが導く3つの安眠効果とストレス解消法【2026年版】
  投稿ID: 1185
  推奨関連記事: 3件
```

### 関連記事の例

**新規記事**:  
「CBD初心者向けの安全な選び方と効果的な使用方法」

**自動推奨された関連記事**:

1. 「フルスペクトラム・ブロードスペクトラム・アイソレートの違い｜CBDの効果・選び方・エビデンス解説」
2. 「CBDオイルの正しい選び方：安心して始めるための完全ガイド」
3. 「CBD入りバスボム・アロマ・キャンドル： 自宅スパの作り方とリラックス効果」

---

## 💡 利用シーン

### ✅ 実装前の課題

- 記事が孤立していて、読者の次のステップが不明確
- サイト滞在時間が短い
- 他の関連記事への誘導ができていない

### 🎯 実装後の効果

1. **サイト滞在時間向上**: 読者が関連記事へ移動 → 複数記事を読む
2. **SEO 効果**: クローラーが記事間リンクを認識 → サイト構造が改善
3. **ユーザー体験向上**: 「次は何を読もう？」という迷いが減少
4. **自動化**: 手動で関連記事を選ぶ必要がない

---

## 🔄 処理フロー

### AI による推奨ロジック

```python
# プロンプト例
新規記事: CBD初心者向けの安全な選び方と効果的な使用方法
キーワード: CBD, 初心者, 選び方, 安全, 使用方法

既存記事候補:
1. フルスペクトラム・ブロードスペクトラム・アイソレートの違い...
2. CBDオイルの正しい選び方...
3. CBD入りバスボム・アロマ・キャンドル...
...

AI の判定:
→ 記事1、記事2、記事3が最適 (関連度が高い)
```

---

## 📁 ファイル構成

```
automation/
├── content/
│   ├── related_articles_connector.py     ✨【新規】
│   ├── article_generator_html_v2.py      【改修】
│   └── ...
└── google_services/
    └── google_sheets.py
```

---

## 🧪 テストケース

### テストケース1: 関連記事の自動推奨

```
入力:
  新規記事タイトル: CBD初心者向けの安全な選び方...
  キーワード: CBD,初心者,選び方

期待値:
  ✓ 関連記事 3 件が自動推奨される
  ✓ 推奨理由が「関連テーマの詳細解説」と表示される

実結果:
  ✅ 成功 - 3 件の関連記事が推奨された
```

### テストケース2: HTML セクション生成

```
入力:
  関連記事リスト: [(タイトル1, URL1, 理由), ...]

期待値:
  ✓ SWELL 互換の HTML が生成される
  ✓ 外部リンクは target="_blank" が付く
  ✓ 区切り線が上部に配置される

実結果:
  ✅ 成功 - 正確な HTML が生成された
```

### テストケース3: 記事生成からHTML 追加まで

```
入力:
  Article_Theme シートの「新規」ステータス行

期待値:
  ✓ 記事が生成される
  ✓ 関連記事が自動推奨される
  ✓ HTML に関連記事セクションが追加される
  ✓ WordPress に投稿される

実結果:
  ✅ 成功 - 2 件の記事で完全に動作確認
```

---

## ⚙️ パラメータ設定

| 項目 | 値 | 説明 |
|------|-----|------|
| 推奨関連記事数 | 3 件 | 各記事に追加される関連記事の最大数 |
| キーワード抽出数 | 5 個 | タイトルから抽出される主要キーワード |
| 関連度閾値 | 0.3 | キーワードマッチングの最小スコア |
| AI モデル | gemini-2.5-flash | Gemini API の使用モデル |

---

## 🚀 今後の拡張案

### 1. ユーザーフィードバック機能

- 「この関連記事は役に立ったか？」という評価システム
- フィードバックに基づいた AI の学習

### 2. ホットキーワード検出

- トレンドキーワードを検出して自動で関連記事を更新
- 季節性を考慮した推奨

### 3. カスタマイズ機能

- ユーザーが推奨理由をカスタマイズ可能
- 関連記事の表示順序を手動で調整

### 4. A/B テスト

- 関連記事の有無での CVR 比較
- 最適な表示位置の検证

---

## 📌 重要な注意点

### ✅ 正常に動作する条件

1. Article_List シートに十分な既存記事がある（最低 3 件以上推奨）
2. 各記事に明確なタイトルが設定されている
3. Gemini API キーが正しく設定されている
4. ARTICLE_LIST_SHEET 名が「Article_List」に統一されている

### ⚠️ 注意事項

- 既存記事が少ない場合、関連記事が推奨されない可能性あり
- AI による推奨のため、時々意外な関連記事が選ばれる場合もある
- 大量の記事生成時は API レート制限に注意

---

## 📞 サポート

### よくある質問

**Q: 関連記事が表示されない場合は？**  
A: Article_List シートに十分な既存記事があるか確認してください。

**Q: 推奨される関連記事の質を改善したい場合は？**  
A: プロンプト内の「推奨理由」の条件を調整してください。

**Q: 関連記事の個数を変更したい場合は？**  
A: `max_related=3` のパラメータを調整してください。

---

## ✅ チェックリスト

- [x] 関連記事推奨エンジンの作成
- [x] AI による自動マッチング実装
- [x] HTML 生成ロジックの実装
- [x] article_generator_html_v2.py への統合
- [x] テスト実行と動作確認
- [x] ドキュメント作成

---

## 🎉 完了

**優先度4「関連記事の自動連携」の実装が完了しました！**

次のステップ：**優先度5「テンプレートのさらなる細分化・ユーザー選択型タイトル機能」**

